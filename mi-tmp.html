<!doctype html>
<html>
  <head>
    <title>mini shell</title>
    <style>html { box-sizing: border-box; }

*, *:before, *:after { box-sizing: inherit; }

html,body {
  height: 100%;
  margin: 0; padding: 0;
  border: none;
  overflow: hidden;
}

iframe.boot, iframe.ui {
  position: fixed;
  height: 100%; width: 100%;
  border: none;
}</style>
  </head>
  <body>

<script id=bootui.js type=data>var root = require('root');

var start = dateNow();

var loadTitle = elem('h2', 'Loading ', document.body);
var tag = elem('span', { text: 'body', color: 'tomato' }, loadTitle);
elem('span', ' (', loadTitle);
var time = elem('span', { text: 'now', color: 'silver' }, loadTitle);
elem('span', ')...', loadTitle);

loadMod({
  eval: 'console.log(0);',
  path: 'headless-boot.js'
});


setInterval(function() {
  setText(time, (dateNow()-start)/1000+' s.');
  var loadingElem = root.document.all[root.document.all.length-1];
  var openingTag = loadingElem.innerHTML ?
      loadingElem.outerHTML.slice(0, loadingElem.outerHTML.indexOf(loadingElem.innerHTML)) :
  		loadingElem.outerHTML;
  setText(tag, openingTag);
}, 130);</script>
<script id=shell.js type=data>elem('h3', {
  text: 'Ready!',
  color: 'silver'
}, document.body);

loadMod({
  eval: 'console.log("running a headless module from within shell");',
  path: 'headless.js'
});

try {
var root = require('root');
var shell = require('shell');
var pan = new shell.Panels(document.body);
var diviLeft = new shell.DirectoryViewer(pan.leftPanel, root.rootfs.files);
var diviRight = new shell.DirectoryViewer(pan.rightPanel, root.rootfs.files);

diviLeft.runfile = diviRight.runfile = function runfile(path) {
  var fi = root.rootfs.files[path];
  if (!fi) {
    alert('No file found: '+path);
    return;
  }

  var content = fi.read();

  var result = loadMod({
    eval: content,
    path: path
  });

  if (result.exports) {
    alert(result.exports);
  }
};

var currentLeft = true;
pan.rightPanel.style.opacity = 0.5;
onEvent(window, 'keydown', function(e) {
  if (e.keyCode===9) { // tab
    if (currentLeft) {
      currentLeft = false;
      pan.leftPanel.style.opacity = 0.5;
      pan.rightPanel.style.opacity = 1;
    }
    else {
      currentLeft = true;
      pan.rightPanel.style.opacity = 0.5;
      pan.leftPanel.style.opacity = 1;
    }
    if (e.preventDefault) e.preventDefault();
    e.cancelBubble = true;
    return;
  }

  if (currentLeft)
  	diviLeft.onkey(e);
  else
    diviRight.onkey(e);
});

setTimeout(function() { window.focus(); }, 1);

console.log('shell is OK');
}
catch (error) {
  alert('shell error ' + error + '\n'+error.message+'\n'+error.stack);
}</script>

<script>
function bootShell() {
    var bootStyle = elem('style', 'iframe.ui{display:none;} ' + 'iframe.boot{display:block;}', document.body);
    var childScopeGenerator = function (global) {
        return {
            elem: elem.bind(global),
            dateNow: dateNow,
            onEvent: onEvent,
            offEvent: offEvent,
            setText: setText,
            loadMod: loadMod.bind(global),
            require: require
        };
    };
    var bootFrame = loadMod({
        style: 'boot',
        eval: getElementText('bootui.js'),
        path: 'bootui.js',
        scope: childScopeGenerator,
        ui: true
    });
    onEvent(window, 'load', function onloadCompleted() {
        var ui = loadMod({
            style: 'ui',
            eval: getElementText('shell.js'),
            path: 'shell.js',
            scope: childScopeGenerator,
            ui: true
        });
        document.body.removeChild(bootStyle);
        document.body.removeChild(bootFrame.iframe);
        bootFrame.iframe.focus();
    });
    function require(module) {
        if (module === 'root') {
            return window;
        }
        else if (module === 'shell') {
            return shell;
        }
    }
    function getElementText(name) {
        var el = document.getElementById(name);
        return el.text || el.innerText || el.innerHTML;
    }
}
function dateNow() {
    return Date.now ? Date.now() : new Date().getTime();
}
function elem(tag, style, parent) {
    var e = tag.tagName ? tag : this.document.createElement(tag);
    if (!style && parent && parent.tagName) {
        parent = style;
        style = null;
    }
    if (style) {
        if (typeof style === 'string') {
            setText(e, style);
        }
        else {
            for (var k in style)
                if (style.hasOwnProperty(k)) {
                    if (k === 'text') {
                        setText(e, style[k]);
                    }
                    else if (k === 'className') {
                        e.className = style[k];
                    }
                    else {
                        try {
                            e.style[k] = style[k];
                        }
                        catch (err) {
                            if (typeof console !== 'undefined' && typeof console.error === 'function')
                                console.error(err);
                        }
                    }
                }
        }
    }
    if (parent)
        parent.appendChild(e);
    return e;
}
function onEvent(e, eventName, handler) {
    if (e.addEventListener)
        e.addEventListener(eventName, handler, false);
    else if (e.attachEvent)
        e.attachEvent('on' + eventName, handler);
    else if ('on' + eventName in e)
        e['on' + eventName] = handler;
    else if (typeof console !== 'undefined' && typeof console.warn === 'function')
        console.warn('Neither addEventListener nor attachEvent nor on' + eventName + ' on ' + e + ' ' + e.tagName + '.');
}
function offEvent(e, eventName, handler) {
    if (e.addEventListener)
        e.addEventListener(eventName, handler, false);
    else if (e.attachEvent)
        e.attachEvent('on' + eventName, handler);
    else if ('on' + eventName in e)
        e['on' + eventName] = handler;
    else if (typeof console !== 'undefined' && typeof console.warn === 'function')
        console.warn('Neither addEventListener nor attachEvent nor on' + eventName + ' on ' + e + ' ' + e.tagName + '.');
}
function setText(e, text) {
    if (!/^BODY$/i.test(e.tagName) && 'text' in e)
        e.text = text;
    else if ('textContent' in e)
        e.textContent = text;
    else if ('innerText' in e)
        e.innerText = text;
    else if ('innerHTML' in e)
        e.innerHTML = text;
    else if (typeof console !== 'undefined' && typeof console.error === 'function')
        console.error('Cannot neither text nor textContent nor innerText nor innerHTML is present on element ' + e + ' ' + e.tagName + '.');
}
function loadMod(options) {
    var style = options.style;
    if (!options.ui) {
        if (!style) {
            style = {
                display: 'none'
            };
        }
        else if (typeof style === 'string') {
            style = {
                className: style,
                display: 'none'
            };
        }
        else {
            var overrideStyle = {};
            for (var k in style)
                if (style.hasOwnProperty(k)) {
                    overrideStyle[k] = style[k];
                }
        }
    }
    var frame = createFrame(this.document, style);
    var frameFunction = frame.global.Function;
    if (options.scope) {
        var scope = typeof options.scope === 'function' ? options.scope(frame.global) : options.scope;
        for (var k in scope)
            if (scope.hasOwnProperty(k)) {
                frame.global[k] = scope[k];
            }
    }
    var html = '<!doctype html><html><head><style>\n' + 'html { box-sizing: border-box; }\n' + '*, *:before, *:after { box-sizing: inherit; }\n' + 'html,body {\n' + '  height: 100%;\n' + '  margin: 0; padding: 0;\n' + '  border: none;\n' + '  overflow: hidden;\n' + '}\n' + '</style></head>\n' + '<body></body></html>';
    if (frame.document.open)
        frame.document.open();
    frame.document.write(html);
    if (frame.document.close)
        frame.document.close();
    if (options.eval) {
        var exportsInScope = scope && 'exports' in scope;
        var evalArgNames = exportsInScope ? [] : [
            'exports'
        ];
        var evalArgs = exportsInScope ? [] : [
            {}
        ];
        if (scope) {
            for (var k in scope)
                if (scope.hasOwnProperty(k)) {
                    evalArgNames.push(k);
                    evalArgs.push(scope[k]);
                }
        }
        if (!options.ui) {
            var allowedGlobals = {
                setTimeout: 1,
                setInterval: 1,
                clearTimeout: 1,
                clearInterval: 1,
                eval: 1,
                console: 1,
                undefined: 1,
                Array: 1,
                Date: 1,
                Function: 1,
                String: 1,
                Boolean: 1,
                Number: 1,
                Infinity: 1,
                NaN: 1,
                isNaN: 1,
                isFinite: 1,
                parseInt: 1,
                parseFloat: 1,
                escape: 1,
                unescape: 1,
                Int32Array: 1,
                Int8Array: 1,
                Int16Array: 1,
                UInt32Array: 1,
                UInt8Array: 1,
                UInt8ClampedArray: 1,
                UInt16Array: 1,
                Float32Array: 1,
                Float64Array: 1,
                ArrayBuffer: 1,
                Math: 1,
                JSON: 1,
                RegExp: RegExp,
                Error: 1,
                SyntaxError: 1,
                EvalError: 1,
                RangeError: 1,
                ReferenceError: 1,
                toString: 1,
                toJSON: 1,
                toValue: 1,
                Map: 1
            };
            var hiddenKeys = {};
            // normal properties
            for (var k in frame.global) {
                if (scope && scope.hasOwnProperty(k))
                    continue;
                if (allowedGlobals.hasOwnProperty(k))
                    continue;
                evalArgNames.push(k);
                hiddenKeys[k] = 1;
            }
            // non-enumerable properties directly on global
            if (Object.getOwnPropertyNames) {
                var props = Object.getOwnPropertyNames(frame.global);
                for (var i = 0; i < props.length; i++) {
                    if (scope && scope.hasOwnProperty(props[i]))
                        continue;
                    if (allowedGlobals.hasOwnProperty(props[i]))
                        continue;
                    if (hiddenKeys.hasOwnProperty(props[i]))
                        continue;
                    evalArgNames.push(props[i]);
                }
                // non-enumerable properties on global's prototype
                if (frame.global.constructor && frame.global.constructor.prototype && frame.global.constructor.prototype != Object && frame.global.constructor.prototype != Object.prototype) {
                    props = Object.getOwnPropertyNames(frame.global.constructor.prototype);
                    for (var i = 0; i < props.length; i++) {
                        if (scope && scope.hasOwnProperty(props[i]))
                            continue;
                        if (allowedGlobals.hasOwnProperty(props[i]))
                            continue;
                        if (hiddenKeys.hasOwnProperty(props[i]))
                            continue;
                        evalArgNames.push(props[i]);
                    }
                }
            }
        }
        evalArgNames.push(options.path ? options.eval + '\nreturn exports; //# sourceURL=' + options.path : options.eval);
        var evalFn = frameFunction.apply(frame.global, evalArgNames);
        var modExports = evalFn.apply(frame.global, evalArgs);
        return {
            document: frame.document,
            global: frame.global,
            iframe: frame.iframe,
            exports: modExports
        };
    }
    return frame;
    function createFrame(document, styleOrClassName) {
        var frm = elem('iframe', typeof styleOrClassName === 'string' ? {
            className: styleOrClassName
        } : styleOrClassName);
        frm.src = 'about:blank';
        document.body.appendChild(frm);
        if (frm.contentWindow && frm.contentWindow.document && frm.contentWindow.document !== document)
            return {
                global: frm.contentWindow,
                document: frm.contentWindow.document,
                iframe: frm
            };
        if (frm.document && frm.document !== document && frm.alert)
            return {
                global: frm,
                document: frm.document,
                iframe: frm
            };
    }
}
var rootfs;
(function (rootfs) {
    rootfs.files = {};
    function file(path, mode, size, attributes) {
        var scriptElem = document.all[document.all.length - 1];
        var fillElements;
        var prevComment = scriptElem.previousSibling;
        while (prevComment) {
            if (prevComment.tagName) {
                prevComment = null;
                break;
            }
            if (prevComment.nodeType === 8)
                break;
            (fillElements || (fillElements = [])).push(prevComment);
            prevComment = prevComment.previousSibling;
        }
        if (!prevComment) {
            if (typeof console !== 'undefined' && typeof console.error === 'function')
                console.error('Cannot find HTML DOM comment related to file ' + path + '.');
            return;
        }
        rootfs.files[path] = new FileNode(prevComment, mode, size, attributes, scriptElem, fillElements);
    }
    rootfs.file = file;
    var FileNode = (function () {
        function FileNode(_node, _mode, _size, _attributes, _script, _other) {
            this._node = _node;
            this._mode = _mode;
            this._size = _size;
            this._attributes = _attributes;
            this._script = _script;
            this._other = _other;
        }
        FileNode.prototype.read = function () {
            var text = this._node.data || this._node.text || this._node.textContent || this._node.innerText;
            switch (this._mode) {
                // to ensure correct newlines regardless of browser quirks
                case 'text-CR':
                    return decodeTextContent(text, '\r');
                case 'text-LF':
                    return decodeTextContent(text, '\n');
                case 'text-CRLF':
                    return decodeTextContent(text, '\r\n');
                case 'base64':
                    // TODO: implement base64 decoding here
                    break;
                case 'json':
                    return JSON.parse(text);
                case 'eval':
                    return eval(text);
                default:
                    return null;
            }
        };
        FileNode.prototype.write = function (content) {
            if (content === null) {
                // TODO: deletion
                return;
            }
            var newContent;
            if (typeof content === 'string') {
            }
            else if (content && typeof content.length === 'number') {
            }
            else {
                newContent = JSON.stringify(content);
                newContent = safeJSON(newContent);
                this._mode = 'json';
            }
            if ('data' in this._node)
                this._node.data = newContent;
            else if ('text' in this._node)
                this._node.text = newContent;
            else if ('textContent' in this._node)
                this._node.textContent = newContent;
            else if ('innerText' in this._node)
                this._node.innerText = newContent;
            else if ('innerHTML' in this._node)
                this._node.innerHTML = newContent;
            else
                throw new Error('Cannot update HTML comment text.');
        };
        FileNode.prototype.getSize = function () {
            if (!this._size) {
                var content = this.read();
                this._size = content ? content.length : 0;
            }
            return this._size;
        };
        return FileNode;
    })();
    function decodeTextContent(s, newLine) {
        return s.replace(/(\r\n|\r|\n)/g, newLine).replace(/\-\-\**\>/g, decodeReplaceFN);
    }
    function decodeReplaceFN(s) {
        return s.slice(0, s.length - 2) + '>';
    }
    function safeJSON(json) {
        if (!json)
            return json;
        var results;
        var lastStart = 0;
        for (var i = 0; i < json.length; i++) {
            var cod = json.charCodeAt(i);
            if (cod < 32 || cod > 126) {
                if (!results)
                    results = [
                        json.slice(0, i)
                    ];
                else
                    results.push(json.slice(lastStart, i));
                lastStart = i + 1;
                var num = cod.toString(16);
                results.push(cod < 0x10 ? '\\u000' + num : cod < 0x100 ? '\\u00' + num : cod < 0x1000 ? '\\u0' + cod : '\\u' + cod);
            }
        }
        if (results) {
            results.push(json.slice(lastStart));
            return results.join('');
        }
        else {
            return json;
        }
    }
    rootfs.safeJSON = safeJSON;
})(rootfs || (rootfs = {}));
var shell;
(function (shell) {
    var DirectoryViewer = (function () {
        function DirectoryViewer(_host, _files) {
            var _this = this;
            this._host = _host;
            this._files = _files;
            this._currentDir = null;
            this.selected = null;
            this.runfile = null;
            this._showDir('/');
            onEvent(this._host, 'click', function (e) {
                return _this._onclick(e.target || e.srcElement);
            });
        }
        DirectoryViewer.prototype.onkey = function (e) {
            var handled = false;
            switch (e.keyCode) {
                case 38:
                    this._moveSelection(-1);
                    handled = true;
                    break;
                case 40:
                    this._moveSelection(+1);
                    handled = true;
                    break;
                case 13:
                    if (this.selected)
                        this._onclick(this.selected);
                    handled = true;
                    break;
                case 8:
                    break;
            }
            if (handled) {
                if (e.preventDefault)
                    e.preventDefault();
                e.cancelBubble = true;
            }
        };
        DirectoryViewer.prototype._moveSelection = function (direction) {
            if (!this.selected)
                return;
            var forward = direction > 0 ? function (item) {
                return item.nextSibling;
            } : function (item) {
                return item.previousSibling;
            };
            var next = forward(this.selected);
            if (next === null)
                return;
            if (!next.getAttribute || !next.getAttribute('data-path'))
                return;
            next.style.background = 'cyan';
            this.selected.style.background = null;
            this.selected = next;
        };
        DirectoryViewer.prototype._showDir = function (dir) {
            var _this = this;
            if (dir.charAt(dir.length - 1) !== '/')
                dir += '/';
            var dirs = [];
            var dirsByName = {};
            var files = [];
            for (var k in this._files)
                if (this._files.hasOwnProperty(k)) {
                    if (k.length < dir.length)
                        continue;
                    var lead = k.slice(0, dir.length);
                    if (lead !== dir)
                        continue;
                    var trail = k.slice(dir.length);
                    var slashPos = trail.indexOf('/');
                    if (slashPos < 0) {
                        files.push({
                            path: k,
                            name: trail,
                            read: function () {
                                return _this._files[k].read();
                            },
                            write: function (data) {
                                return _this._files[k].write(data);
                            }
                        });
                    }
                    else {
                        var dirName = trail.slice(0, slashPos);
                        if (dirsByName.hasOwnProperty(dirName))
                            continue;
                        var d = {
                            path: dir + dirName + '/',
                            name: dirName
                        };
                        dirs.push(d);
                        dirsByName[dirName] = d;
                    }
                }
            dirs.sort(function (d1, d2) {
                return d1.name > d2.name ? +1 : d1.name < d2.name ? -1 : 0;
            });
            if (dir !== '/') {
                var lastSlashPos = dir.lastIndexOf('/', dir.length - 2);
                var parentDir = dir.slice(0, lastSlashPos + 1);
                dirs.unshift({
                    path: parentDir,
                    name: '..'
                });
            }
            files.sort(function (f1, f2) {
                return f1.name > f2.name ? +1 : f1.name < f2.name ? -1 : 0;
            });
            setText(this._host, '');
            this.selected = null;
            elem('div', {
                text: dir,
                marginTop: '-1em',
                textAlign: 'center',
                maxHeight: '1em',
                fontWeight: 'bold'
            }, this._host);
            for (var i = 0; i < dirs.length; i++) {
                var dirElem = elem('div', {
                    text: '[' + dirs[i].name + ']',
                    cursor: 'pointer'
                }, this._host);
                if (this._currentDir && dirs[i].path === this._currentDir) {
                    if (this.selected)
                        this.selected.style.background = null;
                    dirElem.style.background = 'cyan';
                    this.selected = dirElem;
                }
                dirElem.setAttribute('data-path', dirs[i].path);
                if (!this.selected) {
                    dirElem.style.background = 'cyan';
                    this.selected = dirElem;
                }
            }
            for (var i = 0; i < files.length; i++) {
                var fileElem = elem('div', files[i].name, this._host);
                fileElem.setAttribute('data-path', files[i].path);
                if (!this.selected) {
                    this.selected = fileElem;
                    fileElem.style.background = 'cyan';
                }
            }
            this._currentDir = dir;
        };
        DirectoryViewer.prototype._onclick = function (target) {
            while (true) {
                if (!target)
                    return;
                var dataPath = target.getAttribute && target.getAttribute('data-path');
                if (dataPath)
                    break;
                target = target.parentElement;
            }
            if (dataPath.charAt(dataPath.length - 1) === '/') {
                this._showDir(dataPath);
            }
            else {
                if (this.runfile) {
                    this.runfile(dataPath);
                    return;
                }
                alert('Open file ' + dataPath);
            }
        };
        return DirectoryViewer;
    })();
    shell.DirectoryViewer = DirectoryViewer;
})(shell || (shell = {}));
var shell;
(function (shell) {
    var Panels = (function () {
        function Panels(_host) {
            this._host = _host;
            this._leftHost = elem('div', {
                position: 'fixed',
                width: '49.9%',
                top: '0px',
                bottom: '3em',
                padding: '0.25em',
                background: 'cornflowerBlue',
                zIndex: 100
            }, this._host);
            this.leftPanel = elem('div', {
                width: '100%',
                height: '100%',
                border: 'solid 1px white',
                padding: '0.25em'
            }, this._leftHost);
            this._rightHost = elem('div', {
                position: 'fixed',
                left: '50.2%',
                width: '49.9%',
                top: '0px',
                bottom: '3em',
                padding: '0.25em',
                background: 'cornflowerBlue',
                zIndex: 100
            }, this._host);
            this.rightPanel = elem('div', {
                width: '100%',
                height: '100%',
                border: 'solid 1px white',
                padding: '0.25em'
            }, this._rightHost);
        }
        return Panels;
    })();
    shell.Panels = Panels;
})(shell || (shell = {}));


  try {
    bootShell();
  } catch (err) {
    alert(err+(err.stack ? ' '+err.stack:''));
  }

//# sourceURL=/index.html.script
</script>

    <!--123--><script>rootfs.file('/LF-file.txt', 'text-LF')</script>
    <!--123--><script>rootfs.file('/src/LF-file.txt', 'text-LF')</script>
    <!--123--><script>rootfs.file('/src1/LF-file.txt', 'text-LF')</script>
    <!--123
          4--><script>rootfs.file('/CRLF-file', 'text-CRLF', 4)</script>
    <!--"new ok" + String.fromCharCode(Math.random()*16000)+" and what\r\n or "+String.fromCharCode(1)+"?"--><script>rootfs.file('/eval-file.txt', 'eval')</script>
    <!--"new ok \u2222 and what\r\n or \u0001?"--><script>rootfs.file('/json-file.txt', 'json')</script>
    <!--console.log(123)--><script>rootfs.file('/runme.js', 'text-LF')</script>

		<script src-s='https://mi.su/1.js'></script>

  </body>
</html>